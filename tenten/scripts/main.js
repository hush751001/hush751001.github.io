"use strict";function clearPlayground(){var o,e;for(o=0;o<TEN;o++)for(playground[o]=[],e=0;e<TEN;e++)playground[o][e]=PLAYGROUND_COLOR_INDEX;score=0,$(".score span").text(score)}function drawBackground(){clearPlayground(),backgroundBlock=new Block(PLAYGROUND_COLOR_INDEX,PLAYGROUND_TYPE_INDEX),$(".bg").html(backgroundBlock.makeHtmlString())}function isValid(o,e,r){var t,i;for(t=0;t<r.width;t++)for(i=0;i<r.height;i++)if("X"!=r.layout[i][t]){if(e+i>=TEN||o+t>=TEN)continue;if(playground[e+i][o+t]!=PLAYGROUND_COLOR_INDEX)return!1}return!0}function makeRemainBlock(){$(".footer").html('<div class="remain-block remain-block0"></div><div class="remain-block remain-block1"></div><div class="remain-block remain-block2"></div>');for(var o=0;o<3;o++){var e=new Block(parseInt(Math.random()*PLAYGROUND_COLOR_INDEX,10),parseInt(Math.random()*PLAYGROUND_TYPE_INDEX,10));$(".remain-block"+o).html(e.makeHtmlString()).data("block",e)}var r;bowser.mobile&&(r={top:150,left:0}),$(".remain-block").draggable({cursor:"move",cursorAt:r,drag:function(){var o=$(".bg").offset(),e=$(".bg").width(),r=$(this).offset(),t=$(this).data("block"),i=(t.layout,t.color,t.height),a=t.width,l=e/TEN,n=l/2,c=parseInt((n+r.left-o.left)/l,10),s=parseInt((n+r.top-o.top)/l,10);if(!(r.left-o.left<-n||c+a>TEN||r.top-o.top<-n||s+i>TEN))return isValid(c,s,t)?(t.x=c,t.y=s,t.valid=!0,!0):void(t.valid=void 0)},revert:!0})}function resetDivColor(o,e,r,t){t=void 0!==t?t:300,setTimeout(function(){$(".bg .horz").eq(e).children(".block").eq(o).attr("class","block color-"+r)},t)}function removeLines(){var o,e,r,t,i,a,l=0;for(r=0;r<TEN;r++){for(a=i=!0,t=0;t<TEN;t++)a&&playground[r][t]==PLAYGROUND_COLOR_INDEX&&(a=!1),i&&playground[t][r]==PLAYGROUND_COLOR_INDEX&&(i=!1);if(a){for(o=0;o<TEN;o++)playground[r][o]=PLAYGROUND_COLOR_INDEX,resetDivColor(o,r,PLAYGROUND_COLOR_INDEX);l++}if(i){for(e=0;e<TEN;e++)playground[e][r]=PLAYGROUND_COLOR_INDEX,resetDivColor(r,e,PLAYGROUND_COLOR_INDEX);l++}}l>0&&(score+=scoreWeight[l-1])}function checkGameover(){var o=getHiddenRemainBlock(),e=0;o.each(function(){var o,r,t=$(this).data("block");for(o=0;o<TEN-t.width;o++)for(r=0;r<TEN-t.height;r++)if(isValid(o,r,t))return;e++}),o.length==e&&setTimeout(function(){$(".game-over").addClass("game-over-on"),$(".footer").empty()},500)}function getHiddenRemainBlock(){return $(".remain-block").filter(function(){return"hidden"!=$(this).css("visibility")})}function print(){}var TEN=10,scoreWeight=[10,30,60,100,1e3,1e3],blockTypes=[[[1]],[[1,1]],[[1],[1]],[["X",1],[1,1]],[[1,"X"],[1,1]],[[1,1],[1,"X"]],[[1,1],["X",1]],[[1,1],[1,1]],[[1,1,1]],[[1],[1],[1]],[[1,1,1],["X","X",1],["X","X",1]],[[1,1,1],[1,"X","X"],[1,"X","X"]],[["X","X",1],["X","X",1],[1,1,1]],[[1,"X","X"],[1,"X","X"],[1,1,1]],[[1,1,1],[1,1,1],[1,1,1]],[[1,1,1,1]],[[1],[1],[1],[1]]],playground=[];blockTypes.push(playground);var PLAYGROUND_TYPE_INDEX=blockTypes.length-1,PLAYGROUND_COLOR_INDEX=6,score,Block=function(o,e){this.color=o,this.type=e,this.layout=blockTypes[this.type],this.height=this.layout.length,this.width=this.layout[0].length};Block.prototype.makeHtmlString=function(){var o,e,r=this.layout,t="";for(o=0;o<r.length;o++){for(t+='<div class="horz">',e=0;e<r[o].length;e++)"X"!=r[o][e]?t+='<div class="block color-'+this.color+'"></div>':t+='<div class="block color-x"></div>';t+="</div>"}return t};var backgroundBlock;$(function(){drawBackground(),$(".bg").droppable({accept:".remain-block",classes:{"ui-droppable-active":"ui-stat-active","ui-droppable-hover":"ui-stat-hover"},drop:function(o,e){var r,t;if(e.draggable&&0!=e.draggable.length){var i=e.draggable.data("block");if(i.valid){for(r=0;r<i.width;r++)for(t=0;t<i.height;t++)1==i.layout[t][r]&&(playground[i.y+t][i.x+r]=i.color,resetDivColor(i.x+r,i.y+t,i.color,0),score++);e.draggable.css("visibility","hidden"),removeLines(),0==getHiddenRemainBlock().length&&makeRemainBlock(),i.valid=void 0,$(".score span").text(score),checkGameover()}}}}),makeRemainBlock(),$(".game-over button").on("click",function(o){drawBackground(),makeRemainBlock(),$(".game-over").removeClass("game-over-on")})});